<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover">
    <title>MoneyFlow Pro | LKR Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', '-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'sans-serif'] },
                    colors: {
                        'income': '#059669',
                        'expense': '#dc2626',
                        'brand': '#4f46e5',
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        body { -webkit-tap-highlight-color: transparent; user-select: none; overscroll-behavior-y: none; }
        #transaction-list::-webkit-scrollbar { width: 0px; }
        
        .glass-header {
            @apply sticky top-0 z-30 backdrop-blur-md bg-slate-50/80 dark:bg-slate-950/80 border-b border-slate-200 dark:border-slate-800 pt-[env(safe-area-inset-top)];
        }

        .bottom-sheet {
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(100%);
        }
        .bottom-sheet.open { transform: translateY(0); }

        .stat-card {
            @apply bg-white dark:bg-slate-900 rounded-3xl p-5 border border-slate-100 dark:border-slate-800 shadow-sm transition-all active:scale-[0.98];
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-slate-50 dark:bg-slate-950 font-sans text-slate-900 dark:text-slate-100 min-h-screen pb-32">

    <!-- Sticky Header -->
    <header class="glass-header px-6 py-4">
        <div class="flex justify-between items-center max-w-2xl mx-auto">
            <div>
                <h1 class="text-xl font-black tracking-tighter flex items-center">
                    MONEYFLOW<span class="text-brand">PRO</span>
                </h1>
                <p id="header-cycle" class="text-[9px] font-black text-slate-400 dark:text-slate-500 uppercase tracking-widest mt-0.5">Calculating...</p>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="toggleDarkMode()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800 transition-transform active:scale-90">
                    <span class="dark:hidden">üåô</span><span class="hidden dark:inline">‚òÄÔ∏è</span>
                </button>
                <button onclick="toggleMenu()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-800">
                    <span class="text-slate-400">‚öôÔ∏è</span>
                </button>
            </div>
        </div>
        <!-- Settings Menu -->
        <div id="settings-menu" class="hidden max-w-2xl mx-auto mt-2 p-2 bg-white dark:bg-slate-900 rounded-2xl border border-slate-200 dark:border-slate-800 shadow-xl">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="downloadBackup()" class="flex items-center justify-center p-3 text-xs font-bold uppercase tracking-tight hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl">üì§ Backup</button>
                <button onclick="importData()" class="flex items-center justify-center p-3 text-xs font-bold uppercase tracking-tight hover:bg-slate-50 dark:hover:bg-slate-800 rounded-xl">üì• Restore</button>
                <button onclick="exportWhatsApp()" class="col-span-2 flex items-center justify-center p-3 text-xs font-bold uppercase tracking-tight bg-brand/5 text-brand rounded-xl">üì± Export to WhatsApp</button>
                <button onclick="clearAllData()" class="col-span-2 p-3 text-[10px] font-bold text-red-500 uppercase">Clear All History</button>
            </div>
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-6 pt-6 space-y-6">

        <!-- Main Balance Card -->
        <div class="bg-gradient-to-br from-indigo-600 to-indigo-900 rounded-[2.5rem] p-8 text-white shadow-2xl shadow-indigo-500/30 relative overflow-hidden">
            <div class="relative z-10">
                <div class="flex justify-between items-start">
                    <p class="text-[10px] font-black uppercase tracking-[0.2em] opacity-60">Net Worth (LKR)</p>
                    <div class="flex space-x-2">
                        <div class="flex items-center bg-white/10 px-2 py-1 rounded-lg">
                            <span class="text-[9px] font-bold">BANK</span>
                        </div>
                        <div class="flex items-center bg-white/10 px-2 py-1 rounded-lg">
                            <span class="text-[9px] font-bold">CASH</span>
                        </div>
                    </div>
                </div>
                <h2 id="total-balance" class="text-4xl font-black tracking-tighter my-4">0.00</h2>
                
                <div class="grid grid-cols-2 gap-4 mt-8 border-t border-white/10 pt-6">
                    <div>
                        <p class="text-[10px] uppercase font-bold opacity-60 mb-1">Bank Balance</p>
                        <p id="bank-total" class="text-lg font-black tracking-tight">0</p>
                    </div>
                    <div>
                        <p class="text-[10px] uppercase font-bold opacity-60 mb-1">Cash In Hand</p>
                        <p id="cash-total" class="text-lg font-black tracking-tight">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pro Insights -->
        <div class="grid grid-cols-2 gap-4">
            <div class="stat-card">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Cycle Savings</p>
                <h3 id="projected-savings" class="text-lg font-black text-income">LKR 0</h3>
                <p id="savings-percent" class="text-[9px] font-bold text-slate-400 mt-1">0% of income kept</p>
            </div>
            <div class="stat-card">
                <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">Daily Allowance</p>
                <h3 id="daily-limit" class="text-lg font-black text-brand">LKR 0</h3>
                <p id="days-left" class="text-[9px] font-bold text-slate-400 mt-1">0 days remaining</p>
            </div>
        </div>

        <!-- Category Breakdown -->
        <section class="stat-card overflow-hidden">
            <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4">Cycle Spending by Category</h3>
            <div id="category-chart" class="space-y-4">
                <!-- Injected via JS -->
                <p class="text-xs text-slate-400 italic py-4 text-center">No expenses logged yet</p>
            </div>
        </section>

        <!-- Spend Goal Indicator -->
        <section class="stat-card">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-[10px] font-black uppercase tracking-widest text-slate-400">Monthly Spend Goal</h3>
                <button onclick="setBudget()" class="text-[9px] font-bold text-brand bg-brand/5 px-2 py-1 rounded-lg">EDIT</button>
            </div>
            <div class="w-full bg-slate-100 dark:bg-slate-800 h-2.5 rounded-full overflow-hidden mb-2">
                <div id="budget-progress" class="bg-brand h-full transition-all duration-1000" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-[10px] font-black text-slate-400 uppercase tracking-tighter">
                <span id="budget-spent">0.00 SPENT</span>
                <span id="budget-goal">GOAL: 0.00</span>
            </div>
        </section>

        <!-- Cycle Navigator -->
        <div class="flex items-center space-x-2">
            <button onclick="changeCycle(-1)" class="stat-card py-4 px-6 flex items-center justify-center active:bg-slate-50">
                <span>‚óÄ</span>
            </button>
            <div class="stat-card flex-1 py-4 text-center">
                <span id="current-cycle-display" class="text-xs font-black uppercase tracking-widest text-slate-800 dark:text-slate-200">Current</span>
            </div>
            <button onclick="changeCycle(1)" class="stat-card py-4 px-6 flex items-center justify-center active:bg-slate-50">
                <span>‚ñ∂</span>
            </button>
        </div>

        <!-- Transaction Log -->
        <div class="space-y-4 pb-24">
            <div class="flex items-center justify-between sticky top-20 z-20 pt-2 bg-slate-50/50 dark:bg-slate-950/50 backdrop-blur-sm px-1">
                <h4 class="text-[10px] font-black uppercase tracking-widest text-slate-400">Transactions</h4>
                <div class="relative">
                    <input type="text" id="search-input" oninput="renderUI()" placeholder="Search..." class="bg-white dark:bg-slate-900 px-4 py-2 rounded-xl text-[10px] border border-slate-200 dark:border-slate-800 outline-none w-32 focus:w-48 transition-all">
                </div>
            </div>
            <div id="transaction-list" class="space-y-3">
                <!-- Transactions here -->
            </div>
        </div>
    </main>

    <!-- Bottom Actions Bar -->
    <div class="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-slate-50 dark:from-slate-950 via-slate-50 dark:via-slate-950 pt-10 pointer-events-none z-40">
        <div class="max-w-2xl mx-auto flex space-x-4 pointer-events-auto">
            <button onclick="openForm('income')" class="flex-1 bg-income text-white py-5 rounded-3xl font-black text-sm shadow-xl shadow-emerald-500/30 active:scale-95 transition-all">
                + INCOME
            </button>
            <button onclick="openForm('expense')" class="flex-1 bg-expense text-white py-5 rounded-3xl font-black text-sm shadow-xl shadow-red-500/30 active:scale-95 transition-all">
                ‚àí SPEND
            </button>
        </div>
        <div class="h-[env(safe-area-inset-bottom)]"></div>
    </div>

    <!-- Multi-Functional Form Sheet -->
    <div id="form-overlay" class="fixed inset-0 bg-slate-950/60 backdrop-blur-sm z-50 hidden opacity-0 transition-opacity duration-300" onclick="closeForm()">
        <div class="bottom-sheet absolute bottom-0 left-0 right-0 bg-white dark:bg-slate-950 rounded-t-[3rem] p-8 shadow-2xl" onclick="event.stopPropagation()">
            <div class="w-12 h-1.5 bg-slate-200 dark:bg-slate-800 rounded-full mx-auto mb-8"></div>
            
            <div class="flex justify-between items-center mb-8">
                <h3 id="form-title" class="text-2xl font-black tracking-tighter">Log Transaction</h3>
                <button onclick="closeForm()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 flex items-center justify-center text-slate-500">‚úï</button>
            </div>

            <form id="tx-form" onsubmit="saveTransaction(event)" class="space-y-6">
                <input type="hidden" id="tx-id">
                <input type="hidden" id="tx-type">
                
                <div class="space-y-1">
                    <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">LKR Amount</label>
                    <input type="number" id="tx-amount" step="0.01" required placeholder="0.00" class="w-full text-5xl font-black bg-transparent outline-none border-b-4 border-slate-100 dark:border-slate-800 py-2 focus:border-brand transition-colors dark:text-white">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="col-span-2">
                         <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Description</label>
                         <input type="text" id="tx-desc" required placeholder="e.g. Weekly Groceries" class="w-full p-5 bg-slate-50 dark:bg-slate-900/50 rounded-2xl outline-none font-bold dark:text-white">
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Category</label>
                        <input type="text" id="tx-category" list="category-options" placeholder="Select..." class="w-full p-4 bg-slate-50 dark:bg-slate-900/50 rounded-2xl outline-none dark:text-white font-bold text-sm">
                        <datalist id="category-options"></datalist>
                    </div>
                    <div>
                        <label class="text-[10px] font-black uppercase text-slate-400 tracking-widest ml-1">Account</label>
                        <select id="tx-account" class="w-full p-4 bg-slate-50 dark:bg-slate-900/50 rounded-2xl outline-none dark:text-white font-bold text-sm">
                            <option value="Bank">Bank Account</option>
                            <option value="Cash">Cash in Hand</option>
                        </select>
                    </div>
                </div>

                <div class="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-900/50 rounded-2xl">
                    <div class="flex items-center space-x-3">
                        <input type="checkbox" id="tx-recurring" class="w-6 h-6 accent-brand rounded-lg">
                        <span class="text-xs font-bold text-slate-500 uppercase">Monthly Bill/EMI</span>
                    </div>
                    <input type="date" id="tx-date" required class="bg-transparent text-xs font-bold dark:text-white">
                </div>

                <button type="submit" id="submit-btn" class="w-full bg-slate-950 dark:bg-brand text-white py-5 rounded-[2rem] font-black text-lg shadow-xl active:scale-95 transition-transform">SAVE RECORD</button>
            </form>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="fixed top-12 left-6 right-6 bg-slate-900 text-white px-6 py-4 rounded-3xl text-[10px] font-black tracking-widest uppercase shadow-2xl opacity-0 translate-y-[-100%] transition-all duration-300 z-[100] text-center pointer-events-none"></div>

    <script>
        const CATEGORIES = {
            income: ['Salary', 'Freelance', 'Dividends', 'Gift', 'Rental', 'Side Business'],
            expense: ['Groceries/Keells', 'PickMe/Uber', 'Dining Out', 'Electricity/Bill', 'Internet/Dialog', 'Rent', 'Shopping', 'Health', 'Transport', 'Lent Money']
        };

        const STORAGE_KEY = 'moneyflow_ultimate_v1';
        const BUDGET_KEY = 'moneyflow_ultimate_budget';
        
        let transactions = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
        let monthlyBudget = parseFloat(localStorage.getItem(BUDGET_KEY) || '200000');
        let cycleOffset = 0;

        function getFinancialCycle(offset = 0) {
            let now = new Date();
            now.setMonth(now.getMonth() + offset);
            const year = now.getFullYear();
            const month = now.getMonth();
            const day = now.getDate();

            let startDate, endDate;
            if (day >= 25) {
                startDate = new Date(year, month, 25);
                endDate = new Date(year, month + 1, 24);
            } else {
                startDate = new Date(year, month - 1, 25);
                endDate = new Date(year, month, 24);
            }
            return { startDate, endDate };
        }

        function init() {
            updateCycleDisplay();
            const txDateInput = document.getElementById('tx-date');
            if (txDateInput) txDateInput.valueAsDate = new Date();
            if (localStorage.getItem('dark_mode_pro') === 'true') document.documentElement.classList.add('dark');
            renderUI();
        }

        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('dark_mode_pro', isDark);
        }

        function toggleMenu() {
            const menu = document.getElementById('settings-menu');
            if (menu) menu.classList.toggle('hidden');
        }

        function changeCycle(dir) {
            cycleOffset += dir;
            updateCycleDisplay();
            renderUI();
        }

        function updateCycleDisplay() {
            const cycle = getFinancialCycle(cycleOffset);
            const opts = { month: 'short', day: 'numeric' };
            const headerCycle = document.getElementById('header-cycle');
            const cycleDisplay = document.getElementById('current-cycle-display');
            
            if (headerCycle) headerCycle.textContent = `${cycle.startDate.toLocaleDateString('en-LK', opts)} - ${cycle.endDate.toLocaleDateString('en-LK', opts)}`;
            if (cycleDisplay) cycleDisplay.textContent = cycle.startDate.toLocaleDateString('en-LK', { month: 'long', year: 'numeric' });
        }

        function setBudget() {
            const val = prompt("Set Cycle Spending Limit (LKR):", monthlyBudget);
            if (val && !isNaN(val)) {
                monthlyBudget = parseFloat(val);
                localStorage.setItem(BUDGET_KEY, monthlyBudget);
                renderUI();
            }
        }

        function openForm(type, editId = null) {
            const overlay = document.getElementById('form-overlay');
            const sheet = overlay ? overlay.querySelector('.bottom-sheet') : null;
            const datalist = document.getElementById('category-options');
            const submitBtn = document.getElementById('submit-btn');
            
            const form = document.getElementById('tx-form');
            if (form) form.reset();
            const txDateInput = document.getElementById('tx-date');
            if (txDateInput) txDateInput.valueAsDate = new Date();
            
            const idInput = document.getElementById('tx-id');
            const typeInput = document.getElementById('tx-type');
            if (idInput) idInput.value = editId || '';
            if (typeInput) typeInput.value = type;
            
            if (datalist) datalist.innerHTML = CATEGORIES[type].map(c => `<option value="${c}">`).join('');

            if (editId) {
                const tx = transactions.find(t => t.id === editId);
                if (tx) {
                    document.getElementById('tx-amount').value = tx.amount;
                    document.getElementById('tx-desc').value = tx.desc;
                    document.getElementById('tx-category').value = tx.category;
                    document.getElementById('tx-account').value = tx.account || 'Bank';
                    document.getElementById('tx-date').value = tx.date;
                    document.getElementById('tx-recurring').checked = tx.isRecurring;
                    const formTitle = document.getElementById('form-title');
                    if (formTitle) formTitle.textContent = "Edit Record";
                    if (submitBtn) submitBtn.textContent = "UPDATE RECORD";
                }
            } else {
                const formTitle = document.getElementById('form-title');
                if (formTitle) formTitle.textContent = type === 'income' ? 'Log Income' : 'Log Expense';
                if (submitBtn) submitBtn.textContent = "SAVE RECORD";
            }
            
            if (overlay) {
                overlay.classList.remove('hidden');
                setTimeout(() => {
                    overlay.classList.add('opacity-100');
                    if (sheet) sheet.classList.add('open');
                }, 10);
            }
            const amountInput = document.getElementById('tx-amount');
            if (amountInput) amountInput.focus();
        }

        function closeForm() {
            const overlay = document.getElementById('form-overlay');
            const sheet = overlay ? overlay.querySelector('.bottom-sheet') : null;
            if (sheet) sheet.classList.remove('open');
            if (overlay) overlay.classList.remove('opacity-100');
            setTimeout(() => {
                if (overlay) overlay.classList.add('hidden');
            }, 300);
        }

        function saveTransaction(e) {
            e.preventDefault();
            const editId = document.getElementById('tx-id').value;
            const txData = {
                amount: parseFloat(document.getElementById('tx-amount').value),
                desc: document.getElementById('tx-desc').value,
                type: document.getElementById('tx-type').value,
                category: document.getElementById('tx-category').value || 'Uncategorized',
                account: document.getElementById('tx-account').value,
                date: document.getElementById('tx-date').value,
                isRecurring: document.getElementById('tx-recurring').checked
            };

            if (editId) {
                const index = transactions.findIndex(t => t.id == editId);
                if (index !== -1) {
                    transactions[index] = { ...transactions[index], ...txData };
                }
            } else {
                transactions.unshift({ id: Date.now(), ...txData });
            }

            localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
            closeForm();
            renderUI();
            showToast(editId ? 'RECORD UPDATED' : 'LOGGED SUCCESSFULLY');
        }

        function deleteTx(id) {
            event.stopPropagation();
            if(!confirm('Delete this record?')) return;
            transactions = transactions.filter(t => t.id !== id);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
            renderUI();
            showToast('RECORD REMOVED');
        }

        function renderUI() {
            const list = document.getElementById('transaction-list');
            const searchInput = document.getElementById('search-input');
            const search = searchInput ? searchInput.value.toLowerCase() : '';
            const cycle = getFinancialCycle(cycleOffset);
            const today = new Date();

            let totalBal = 0, bankBal = 0, cashBal = 0, cIncome = 0, cExpense = 0;
            const catMap = {};

            const filtered = transactions.filter(t => {
                const tDate = new Date(t.date);
                const inCycle = tDate >= cycle.startDate && tDate <= cycle.endDate;
                
                if (t.type === 'income') {
                    totalBal += t.amount;
                    if (t.account === 'Cash') cashBal += t.amount; else bankBal += t.amount;
                } else {
                    totalBal -= t.amount;
                    if (t.account === 'Cash') cashBal -= t.amount; else bankBal -= t.amount;
                }

                if (inCycle) {
                    if (t.type === 'income') {
                        cIncome += t.amount;
                    } else {
                        cExpense += t.amount;
                        catMap[t.category] = (catMap[t.category] || 0) + t.amount;
                    }
                }

                return t.desc.toLowerCase().includes(search) || t.category.toLowerCase().includes(search);
            });

            // Update DOM
            const totalBalEl = document.getElementById('total-balance');
            const bankTotalEl = document.getElementById('bank-total');
            const cashTotalEl = document.getElementById('cash-total');
            if (totalBalEl) totalBalEl.textContent = `LKR ${totalBal.toLocaleString()}`;
            if (bankTotalEl) bankTotalEl.textContent = bankBal.toLocaleString();
            if (cashTotalEl) cashTotalEl.textContent = cashBal.toLocaleString();

            const savingsVal = cIncome - cExpense;
            const projSavingsEl = document.getElementById('projected-savings');
            if (projSavingsEl) {
                projSavingsEl.textContent = `LKR ${savingsVal.toLocaleString()}`;
                projSavingsEl.className = `text-lg font-black ${savingsVal >= 0 ? 'text-income' : 'text-expense'}`;
            }
            
            const sRate = cIncome > 0 ? Math.round((savingsVal / cIncome) * 100) : 0;
            const savingsPercentEl = document.getElementById('savings-percent');
            if (savingsPercentEl) savingsPercentEl.textContent = `${sRate}% of income saved`;

            const diff = cycle.endDate - (today > cycle.startDate ? today : cycle.startDate);
            const daysLeft = Math.ceil(diff / (1000*60*60*24)) || 1;
            const daysLeftEl = document.getElementById('days-left');
            if (daysLeftEl) daysLeftEl.textContent = `${daysLeft} days until 24th`;
            
            const allowance = Math.max(0, (monthlyBudget - cExpense) / daysLeft);
            const dailyLimitEl = document.getElementById('daily-limit');
            if (dailyLimitEl) dailyLimitEl.textContent = `LKR ${Math.floor(allowance).toLocaleString()}`;

            const bPercent = Math.min(100, Math.round((cExpense / monthlyBudget) * 100));
            const budgetProgressEl = document.getElementById('budget-progress');
            const budgetStatusEl = document.getElementById('budget-status');
            const budgetSpentEl = document.getElementById('budget-spent');
            const budgetGoalEl = document.getElementById('budget-goal');

            if (budgetProgressEl) {
                budgetProgressEl.style.width = `${bPercent}%`;
                budgetProgressEl.className = `h-full transition-all duration-1000 ${bPercent > 90 ? 'bg-expense' : 'bg-brand'}`;
            }
            if (budgetStatusEl) budgetStatusEl.textContent = `${bPercent}%`;
            if (budgetSpentEl) budgetSpentEl.textContent = `${cExpense.toLocaleString()} SPENT`;
            if (budgetGoalEl) budgetGoalEl.textContent = `GOAL: ${monthlyBudget.toLocaleString()}`;

            // Render Charts
            const chartDiv = document.getElementById('category-chart');
            if (chartDiv) {
                const sortedCats = Object.entries(catMap).sort((a,b) => b[1] - a[1]);
                if (sortedCats.length > 0) {
                    chartDiv.innerHTML = sortedCats.slice(0, 5).map(([cat, amt]) => {
                        const p = Math.round((amt / cExpense) * 100);
                        return `
                            <div class="space-y-1">
                                <div class="flex justify-between text-[9px] font-black uppercase text-slate-500">
                                    <span class="truncate pr-2">${cat}</span>
                                    <span>LKR ${amt.toLocaleString()} (${p}%)</span>
                                </div>
                                <div class="w-full bg-slate-50 dark:bg-slate-800 h-1.5 rounded-full overflow-hidden">
                                    <div class="bg-brand h-full opacity-60" style="width: ${p}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    chartDiv.innerHTML = `<p class="text-xs text-slate-400 italic py-4 text-center">No spending insights for this cycle</p>`;
                }
            }

            // List Render
            if (list) {
                if (filtered.length === 0) {
                    list.innerHTML = `<div class="text-center py-20 opacity-20 font-black text-xs tracking-widest">NO RECORDS</div>`;
                    return;
                }

                list.innerHTML = filtered.map(t => `
                    <div onclick="openForm('${t.type}', ${t.id})" class="animate-fade bg-white dark:bg-slate-900 p-5 rounded-[2.2rem] flex items-center justify-between shadow-sm active:scale-95 transition-all">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 rounded-2xl flex items-center justify-center ${t.type === 'income' ? 'bg-emerald-50 text-income' : 'bg-red-50 text-expense'}">
                                <span class="text-lg font-black">${t.type === 'income' ? '‚Üì' : '‚Üë'}</span>
                            </div>
                            <div>
                                <p class="font-black text-sm text-slate-800 dark:text-slate-100 leading-none">${t.desc}</p>
                                <div class="flex items-center space-x-2 mt-1.5">
                                    <span class="text-[9px] font-black uppercase text-slate-400 bg-slate-50 dark:bg-slate-800 px-1.5 py-0.5 rounded">${t.category}</span>
                                    <span class="text-[9px] font-black uppercase text-brand/50">${t.account || 'Bank'}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-4">
                            <p class="font-black text-right ${t.type === 'income' ? 'text-income' : 'text-slate-900 dark:text-white'}">
                                ${t.type === 'income' ? '+' : '-'}${t.amount.toLocaleString()}
                            </p>
                            <button onclick="deleteTx(${t.id})" class="text-slate-200 hover:text-red-500">‚úï</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            if (t) {
                t.textContent = msg;
                t.classList.remove('opacity-0', 'translate-y-[-100%]');
                setTimeout(() => {
                    if (t) t.classList.add('opacity-0', 'translate-y-[-100%]');
                }, 2500);
            }
        }

        function exportWhatsApp() {
            const cycle = getFinancialCycle(cycleOffset);
            const projSavingsEl = document.getElementById('projected-savings');
            const budgetSpentEl = document.getElementById('budget-spent');
            const dailyLimitEl = document.getElementById('daily-limit');
            
            let txt = `üí≥ *MONEYFLOW PRO LKR REPORT*\nCycle: ${cycle.startDate.toLocaleDateString('en-LK')} to ${cycle.endDate.toLocaleDateString('en-LK')}\n\n`;
            txt += `üí∞ *Cycle Balance:* ${projSavingsEl ? projSavingsEl.textContent : '0'}\n`;
            txt += `üî¥ Total Spend: LKR ${budgetSpentEl ? budgetSpentEl.textContent.replace('SPENT','') : '0'}\n`;
            txt += `üìÖ *Remaining Daily Budget: ${dailyLimitEl ? dailyLimitEl.textContent : '0'}*\n\n`;
            txt += `Latest Entries:\n`;
            transactions.slice(0, 5).forEach(t => txt += `${t.type === 'income' ? '‚úÖ' : '‚ùå'} ${t.desc}: LKR ${t.amount.toLocaleString()}\n`);

            const el = document.createElement('textarea');
            el.value = txt;
            document.body.appendChild(el);
            el.select();
            document.execCommand('copy');
            document.body.removeChild(el);
            showToast('REPORT COPIED TO CLIPBOARD');
        }

        function downloadBackup() {
            const data = JSON.stringify({ transactions, monthlyBudget, darkMode: localStorage.getItem('dark_mode_pro') });
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `moneyflow_LKR_ultimate_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.onchange = e => {
                const reader = new FileReader();
                reader.onload = ev => {
                    try {
                        const d = JSON.parse(ev.target.result);
                        transactions = d.transactions || [];
                        monthlyBudget = d.monthlyBudget || 200000;
                        localStorage.setItem(STORAGE_KEY, JSON.stringify(transactions));
                        localStorage.setItem(BUDGET_KEY, monthlyBudget);
                        renderUI();
                        showToast('RESTORE COMPLETE');
                    } catch (err) { showToast('INVALID FILE'); }
                };
                reader.readAsText(e.target.files[0]);
            };
            input.click();
        }

        function clearAllData() {
            if (confirm("Permanently wipe all financial history?")) {
                localStorage.clear();
                window.location.reload();
            }
        }

        window.onload = init;
    </script>
</body>
</html>
